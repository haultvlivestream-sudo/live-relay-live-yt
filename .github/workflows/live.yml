name: Live Relay YouTube Bypass

on:
  workflow_dispatch:
    inputs:
      link_youtube:
        description: '1. Tempel Link Video YouTube'
        required: true
      kunci_rtmp:
        description: '2. Tempel Stream Key YouTube'
        required: true

jobs:
  streaming:
    runs-on: ubuntu-latest
    steps:
      - name: Install Tool
        run: |
          sudo apt update
          sudo apt install ffmpeg jq -y

      - name: Eksekusi Bypass dan Live
        run: |
          # 1. Ambil ID Video
          LINK="${{ github.event.inputs.link_youtube }}"
          VIDEO_ID=$(echo $LINK | sed -n 's/.*v=\([^&]*\).*/\1/p; s/.*youtu.be\/\([^?]*\).*/\1/p')
          
          echo "Mencoba ambil link video untuk ID: $VIDEO_ID"

          # 2. Ambil Link Video lewat Jembatan (Invidious)
          # Saya pakai server yang paling stabil saat ini
          VIDEO_URL=$(curl -s "https://iv.melmac.space/api/v1/videos/$VIDEO_ID" | jq -r '.formatStreams[] | select(.container == "mp4") | .url' | head -n 1)

          # 3. Cek apakah link berhasil didapat
          if [ -z "$VIDEO_URL" ] || [ "$VIDEO_URL" == "null" ]; then
            echo "Gagal lewat jembatan, mencoba server cadangan..."
            VIDEO_URL=$(curl -s "https://invidious.drgns.space/api/v1/videos/$VIDEO_ID" | jq -r '.formatStreams[] | select(.container == "mp4") | .url' | head -n 1)
          fi

          # 4. Jalankan Live jika link ada
          if [ ! -z "$VIDEO_URL" ] && [ "$VIDEO_URL" != "null" ]; then
            ffmpeg -re -i "$VIDEO_URL" \
            -c:v libx264 -preset veryfast -b:v 2500k \
            -c:a aac -ar 44100 -b:a 128k \
            -f flv "rtmp://a.rtmp.youtube.com/live2/${{ github.event.inputs.kunci_rtmp }}"
          else
            echo "ERROR: Semua server jembatan gagal mendapatkan link. YouTube mungkin sedang update."
            exit 1
          fi
          
